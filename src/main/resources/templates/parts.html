<!DOCTYPE html>
<html lang="cs" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browse Parts - PC Parts Scraper</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@2.0.3"></script>

    <!-- Chart.js for price statistics charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

    <!-- Configure Tailwind for dark mode -->
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>

    <!-- Theme initialization -->
    <script th:replace="~{fragments/theme-toggle :: theme-init-script}"></script>

    <style>
        /* Remove all border-radius */
        * {
            border-radius: 0 !important;
        }
    </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <div class="min-h-screen flex flex-col max-w-7xl mx-auto">
        <!-- Header -->
        <div th:replace="~{fragments/header :: header('parts')}"></div>

        <!-- Main Content -->
        <main class="flex-1 px-4 sm:px-6 lg:px-8 py-8">
            <div class="space-y-6">
                <!-- Header -->
                <div class="flex justify-between items-center">
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100">Browse PC Parts</h1>
                    <div class="text-sm text-gray-500 dark:text-gray-400">
                        <span th:text="${partsPage.totalElements}">0</span> parts found
                    </div>
                </div>

                <!-- Filters -->
                <div class="bg-white dark:bg-gray-800 shadow border border-gray-200 dark:border-gray-700 p-6">
                    <form id="filterForm" hx-get="/parts/fragment" hx-target="#parts-container"
                        hx-trigger="change, submit" hx-indicator="#loading" class="space-y-4">

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
                            <!-- Part Type Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Part Type
                                </label>
                                <select name="partType"
                                    class="w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                    <option value="">All Types</option>
                                    <option th:each="type : ${partTypes}" th:value="${type}"
                                        th:text="${type.displayName}" th:selected="${currentPartType == type}">Type
                                    </option>
                                </select>
                            </div>

                            <!-- Item Type Filter (GPU, CPU, RAM) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Component Type
                                </label>
                                <select name="itemType" id="itemTypeSelect"
                                    class="w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                    <option value="">All Components</option>
                                    <option th:each="itemType : ${itemTypes}" th:value="${itemType}"
                                        th:text="${itemType}" th:selected="${currentItemType == itemType}">Component
                                    </option>
                                </select>
                            </div>

                            <!-- Model Filter (RTX 5070, Ryzen 7 2700X, etc.) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Model
                                </label>
                                <select name="modelName" id="modelNameSelect"
                                    class="w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                    <option value="">All Models</option>
                                    <option th:each="modelName : ${modelNames}" th:value="${modelName}"
                                        th:text="${modelName}" th:selected="${currentModelName == modelName}">Model
                                    </option>
                                </select>
                            </div>

                            <!-- Marketplace Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Marketplace
                                </label>
                                <select name="marketplace"
                                    class="w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                    <option value="">All Marketplaces</option>
                                    <option th:each="marketplace : ${marketplaces}" th:value="${marketplace}"
                                        th:text="${marketplace}" th:selected="${currentMarketplace == marketplace}">
                                        Marketplace</option>
                                </select>
                            </div>

                            <!-- Source Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Source
                                </label>
                                <select name="source"
                                    class="w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                    <option value="">All Sources</option>
                                    <option th:each="source : ${sources}" th:value="${source}" th:text="${source}"
                                        th:selected="${currentSource == source}">Source</option>
                                </select>
                            </div>

                            <!-- Age Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Max Age
                                </label>
                                <select name="maxAgeDays"
                                    class="w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                    <option value="">Any Age</option>
                                    <option value="1" th:selected="${currentMaxAgeDays == 1}">Last 24 hours</option>
                                    <option value="3" th:selected="${currentMaxAgeDays == 3}">Last 3 days</option>
                                    <option value="7" th:selected="${currentMaxAgeDays == 7}">Last week</option>
                                    <option value="30" th:selected="${currentMaxAgeDays == 30}">Last month</option>
                                </select>
                            </div>
                        </div>

                        <!-- Price Range and Search -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Min Price -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Min Price (CZK)
                                </label>
                                <input type="number" name="minPrice" th:value="${currentMinPrice}" placeholder="0"
                                    class="w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            </div>

                            <!-- Max Price -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Max Price (CZK)
                                </label>
                                <input type="number" name="maxPrice" th:value="${currentMaxPrice}" placeholder="999999"
                                    class="w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            </div>

                            <!-- Search -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Search
                                </label>
                                <input type="text" name="search" th:value="${currentSearch}"
                                    placeholder="Search in title and description..."
                                    hx-trigger="keyup changed delay:500ms"
                                    class="w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            </div>
                        </div>

                        <!-- Sort Options -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Sort By
                                </label>
                                <select name="sortBy"
                                    class="w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                    <option value="scrapedAt" th:selected="${currentSortBy == 'scrapedAt'}">Date Added
                                    </option>
                                    <option value="price" th:selected="${currentSortBy == 'price'}">Price</option>
                                    <option value="title" th:selected="${currentSortBy == 'title'}">Title</option>
                                    <option value="partType" th:selected="${currentSortBy == 'partType'}">Category
                                    </option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Sort Direction
                                </label>
                                <select name="sortDir"
                                    class="w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                    <option value="desc" th:selected="${currentSortDir == 'desc'}">Descending</option>
                                    <option value="asc" th:selected="${currentSortDir == 'asc'}">Ascending</option>
                                </select>
                            </div>
                        </div>

                        <!-- Clear Filters Button -->
                        <div class="flex justify-end">
                            <button type="button" onclick="clearFilters()"
                                class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 text-sm font-medium transition-colors">
                                Clear Filters
                            </button>
                        </div>

                        <!-- Extract Components Button -->
                        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                            <div class="flex flex-wrap gap-2">
                                <button id="extractComponentsBtn"
                                    class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 text-sm font-medium transition-colors">
                                    <svg class="w-4 h-4 inline-block mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z"></path>
                                        <path fill-rule="evenodd"
                                            d="M3 8h14v7a2 2 0 01-2 2H5a2 2 0 01-2-2V8zm5 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"
                                            clip-rule="evenodd"></path>
                                    </svg>
                                    Extract Component Info
                                </button>
                                <small class="text-gray-600 dark:text-gray-400 self-center">
                                    â†‘ Run this to enable "Stats" buttons on listings
                                </small>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Loading Indicator -->
                <div id="loading" class="htmx-indicator">
                    <div class="flex justify-center items-center py-8">
                        <div class="animate-spin h-8 w-8 border-4 border-blue-500 border-t-transparent"></div>
                        <span class="ml-2 text-gray-600 dark:text-gray-400">Loading parts...</span>
                    </div>
                </div>

                <!-- Parts Container -->
                <div id="parts-container">
                    <div th:replace="~{fragments/parts-list :: parts-list}"></div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <div th:replace="~{fragments/footer :: footer}"></div>
    </div>

    <!-- Modal Container -->
    <div id="modal-container"></div>

    <!-- Price Statistics Modal -->
    <div th:replace="~{fragments/price-stats-modal :: price-stats-modal}"></div>

    <!-- Theme Toggle -->
    <div th:replace="~{fragments/theme-toggle :: theme-toggle}"></div>

    <!-- Theme Toggle Script -->
    <script th:replace="~{fragments/theme-toggle :: theme-toggle-script}"></script>

    <script>
        // Price charts variables
        let priceChart = null;
        let trendChart = null;

        function clearFilters() {
            // Reset all form inputs
            document.getElementById('filterForm').reset();
            // Clear model dropdown
            updateModelDropdown('');
            // Trigger HTMX update
            htmx.trigger('#filterForm', 'submit');
        }

        function updateModelDropdown(itemType) {
            const modelSelect = document.getElementById('modelNameSelect');
            const currentModel = modelSelect.value;

            // Clear existing options except "All Models"
            modelSelect.innerHTML = '<option value="">All Models</option>';

            if (itemType && itemType.trim() !== '') {
                // Add loading option
                const loadingOption = document.createElement('option');
                loadingOption.value = '';
                loadingOption.textContent = 'Loading models...';
                loadingOption.disabled = true;
                modelSelect.appendChild(loadingOption);

                // Fetch models for the selected item type
                fetch('/api/models?itemType=' + encodeURIComponent(itemType))
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(models => {
                        // Remove loading option
                        modelSelect.innerHTML = '<option value="">All Models</option>';

                        if (models && models.length > 0) {
                            models.forEach(model => {
                                const option = document.createElement('option');
                                option.value = model;
                                option.textContent = model;
                                if (model === currentModel) {
                                    option.selected = true;
                                }
                                modelSelect.appendChild(option);
                            });
                        } else {
                            const noModelsOption = document.createElement('option');
                            noModelsOption.value = '';
                            noModelsOption.textContent = 'No models found';
                            noModelsOption.disabled = true;
                            modelSelect.appendChild(noModelsOption);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching models:', error);
                        // Remove loading option and show error
                        modelSelect.innerHTML = '<option value="">All Models</option>';
                        const errorOption = document.createElement('option');
                        errorOption.value = '';
                        errorOption.textContent = 'Error loading models';
                        errorOption.disabled = true;
                        modelSelect.appendChild(errorOption);
                    });
            }
        }

        // Handle item type change
        document.getElementById('itemTypeSelect').addEventListener('change', function () {
            const selectedItemType = this.value;
            const modelSelect = document.getElementById('modelNameSelect');

            // Store current model selection before updating dropdown
            const currentModel = modelSelect.value;

            updateModelDropdown(selectedItemType);

            // If item type is cleared or changed, reset model selection
            if (selectedItemType === '') {
                modelSelect.value = '';
            } else {
                // Wait for dropdown to be updated, then check if current model is still valid
                setTimeout(() => {
                    const options = Array.from(modelSelect.options);
                    const modelExists = options.some(option => option.value === currentModel);
                    if (!modelExists) {
                        modelSelect.value = '';
                    }
                }, 50);
            }

            // Trigger form update after a short delay to allow model dropdown to update
            setTimeout(() => {
                htmx.trigger('#filterForm', 'submit');
            }, 200);
        });

        // Initialize model dropdown on page load
        document.addEventListener('DOMContentLoaded', function () {
            const itemTypeSelect = document.getElementById('itemTypeSelect');
            if (itemTypeSelect.value) {
                updateModelDropdown(itemTypeSelect.value);
            }

            // Event delegation for price statistics buttons (including dynamically loaded content)
            document.addEventListener('click', function (event) {
                if (event.target.closest('.price-stats-btn')) {
                    const button = event.target.closest('.price-stats-btn');
                    const modelName = button.getAttribute('data-model-name');
                    const itemType = button.getAttribute('data-item-type');
                    if (modelName && itemType) {
                        showPriceStatisticsModal(modelName, itemType);
                    }
                }
            });

            // Handle Extract Components button
            document.getElementById('extractComponentsBtn').addEventListener('click', function () {
                const button = this;
                const originalText = button.innerHTML;

                // Disable button and show loading state
                button.disabled = true;
                button.innerHTML = `
                    <svg class="w-4 h-4 inline-block mr-1 animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Processing...
                `;

                // Make the API call
                fetch('/scraping/extract-components', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.text())
                    .then(data => {
                        button.innerHTML = `
                        <svg class="w-4 h-4 inline-block mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        Extraction Started!
                    `;

                        // Show success message
                        alert('Component extraction started! Please wait a few minutes and refresh the page to see Stats buttons on listings.');

                        // Reset button after a delay
                        setTimeout(() => {
                            button.disabled = false;
                            button.innerHTML = originalText;
                        }, 5000);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        button.innerHTML = originalText;
                        button.disabled = false;
                        alert('Error starting component extraction. Please try again.');
                    });
            });
        });

        // Price Statistics Modal Functions
        function showPriceStatisticsModal(modelName, itemType) {
            if (!modelName || !itemType) {
                alert('Missing model or item type information');
                return;
            }

            console.log("Opening modal for:", modelName, itemType); // Add debugging

            // Set modal title
            document.getElementById('modal-title').textContent = `Price Statistics for ${modelName}`;

            // Show modal
            const modal = document.getElementById('price-stats-modal');
            if (!modal) {
                console.error("Modal element not found!");
                return;
            }
            modal.classList.remove('hidden');

            // Show loading, hide content and error
            document.getElementById('stats-loading').classList.remove('hidden');
            document.getElementById('stats-content').classList.add('hidden');
            document.getElementById('stats-error').classList.add('hidden');

            // Fetch price statistics
            fetch(`/api/price-statistics?modelName=${encodeURIComponent(modelName)}&itemType=${encodeURIComponent(itemType)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch price statistics');
                    }
                    return response.json();
                })
                .then(data => {
                    // Hide loading, show content
                    document.getElementById('stats-loading').classList.add('hidden');
                    document.getElementById('stats-content').classList.remove('hidden');

                    // Update statistics
                    updatePriceStatistics(data);

                    // Create charts
                    createPriceDistributionChart(data);
                    createPriceTrendChart();
                })
                .catch(error => {
                    console.error('Error fetching price statistics:', error);
                    document.getElementById('stats-loading').classList.add('hidden');
                    document.getElementById('stats-error').classList.remove('hidden');
                    document.getElementById('error-message').textContent = error.message || 'Failed to load price statistics';
                });
        }

        function closePriceStatisticsModal() {
            document.getElementById('price-stats-modal').classList.add('hidden');

            // Destroy charts to prevent memory leaks
            if (priceChart) {
                priceChart.destroy();
                priceChart = null;
            }
            if (trendChart) {
                trendChart.destroy();
                trendChart = null;
            }
        }

        function updatePriceStatistics(data) {
            // Calculate adjusted average by removing anomalies (50%+ difference from median)
            let prices = data.allPrices || [];
            const median = data.medianPrice || 0;

            // Filter out anomalies for adjusted average calculation
            let filteredPrices = [];
            let anomaliesCount = 0;

            if (median > 0) {
                filteredPrices = prices.filter(price => {
                    const difference = Math.abs(price - median) / median;
                    const isAnomaly = difference > 0.5; // 50% threshold
                    if (isAnomaly) anomaliesCount++;
                    return !isAnomaly;
                });
            }

            // Calculate adjusted average
            const adjustedAvg = filteredPrices.length > 0
                ? Math.round(filteredPrices.reduce((a, b) => a + b, 0) / filteredPrices.length)
                : data.averagePrice;

            // Update UI
            document.getElementById('average-price').textContent = formatPrice(data.averagePrice);
            document.getElementById('median-price').textContent = formatPrice(data.medianPrice);
            document.getElementById('min-price').textContent = formatPrice(data.minPrice);
            document.getElementById('max-price').textContent = formatPrice(data.maxPrice);
            document.getElementById('total-listings').textContent = data.totalListings || 0;
            document.getElementById('active-listings').textContent = data.activeListings || 0;

            // Add note about adjusted average if anomalies were found
            const averageNote = document.getElementById('average-note');
            if (anomaliesCount > 0) {
                averageNote.textContent = `Adjusted avg: ${formatPrice(adjustedAvg)} (${anomaliesCount} anomalies removed)`;
                averageNote.classList.remove('hidden');
            } else {
                averageNote.textContent = '';
                averageNote.classList.add('hidden');
            }
        }

        function formatPrice(price) {
            if (price === undefined || price === null) return '0 CZK';
            return new Intl.NumberFormat('cs-CZ').format(price) + ' CZK';
        }

        function createPriceDistributionChart(data) {
            const ctx = document.getElementById('price-chart').getContext('2d');

            // Destroy existing chart if it exists
            if (priceChart) {
                priceChart.destroy();
            }

            // Get price data
            const prices = data.allPrices || [];
            if (prices.length === 0) {
                return;
            }

            // Create price ranges for histogram
            const min = Math.min(...prices);
            const max = Math.max(...prices);
            const range = max - min;
            const bucketSize = range / 10; // 10 buckets

            const buckets = Array(10).fill(0);
            prices.forEach(price => {
                const bucketIndex = Math.min(9, Math.floor((price - min) / bucketSize));
                buckets[bucketIndex]++;
            });

            // Create labels for buckets
            const labels = [];
            for (let i = 0; i < 10; i++) {
                const start = Math.round(min + i * bucketSize);
                const end = Math.round(min + (i + 1) * bucketSize);
                labels.push(`${new Intl.NumberFormat('cs-CZ').format(start)} - ${new Intl.NumberFormat('cs-CZ').format(end)}`);
            }

            // Get theme colors
            const isDarkMode = document.documentElement.classList.contains('dark');
            const textColor = isDarkMode ? '#e5e7eb' : '#374151';
            const gridColor = isDarkMode ? '#4b5563' : '#e5e7eb';

            // Create chart
            priceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of listings',
                        data: buckets,
                        backgroundColor: 'rgba(79, 70, 229, 0.6)',
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function (tooltipItems) {
                                    return tooltipItems[0].label + ' CZK';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: textColor,
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                color: gridColor
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: textColor,
                                precision: 0
                            },
                            grid: {
                                color: gridColor
                            }
                        }
                    }
                }
            });
        }

        function createPriceTrendChart() {
            const ctx = document.getElementById('trend-chart').getContext('2d');

            // Destroy existing chart if it exists
            if (trendChart) {
                trendChart.destroy();
            }

            // Generate simulated data for trend chart (30 days)
            const labels = [];
            const medianData = [];
            const avgData = [];
            const today = new Date();

            // Base price (use actual median if available)
            const basePrice = parseFloat(document.getElementById('median-price').textContent.replace(/[^\d]/g, '')) || 15000;

            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                labels.push(date.toLocaleDateString('cs-CZ', { day: 'numeric', month: 'numeric' }));

                // Generate slightly varied prices for simulation
                const randomFactor = 0.95 + (Math.random() * 0.1); // 0.95 to 1.05
                const trendFactor = 1 + (i - 15) * 0.001; // slight trend over time

                medianData.push(Math.round(basePrice * randomFactor * trendFactor));
                avgData.push(Math.round(basePrice * randomFactor * trendFactor * (0.98 + Math.random() * 0.06)));
            }

            // Get theme colors
            const isDarkMode = document.documentElement.classList.contains('dark');
            const textColor = isDarkMode ? '#e5e7eb' : '#374151';
            const gridColor = isDarkMode ? '#4b5563' : '#e5e7eb';

            // Create chart
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Median Price',
                            data: medianData,
                            borderColor: 'rgba(79, 70, 229, 1)',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: 'Average Price',
                            data: avgData,
                            borderColor: 'rgba(236, 72, 153, 1)',
                            backgroundColor: 'rgba(236, 72, 153, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.dataset.label + ': ' + new Intl.NumberFormat('cs-CZ').format(context.raw) + ' CZK';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: textColor
                            },
                            grid: {
                                color: gridColor
                            }
                        },
                        y: {
                            ticks: {
                                color: textColor
                            },
                            grid: {
                                color: gridColor
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>

</html>